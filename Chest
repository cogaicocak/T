local NEXT_PLACE_ID = 123456789
local TP_CHEST_COOLDOWN = 0.6
local PLACE_RETRY_DELAY = 0.25
local PLACE_MAX_ATTEMPTS = 10

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer

local function getCharacter()
	if not LocalPlayer.Character then
		LocalPlayer.CharacterAdded:Wait()
	end
	LocalPlayer.Character:WaitForChild("HumanoidRootPart")
	return LocalPlayer.Character
end

local UncheckedChests = {}
local FirstRun = true

local function DistanceFromPlrSort(ObjectList)
	local char = getCharacter()
	local RootPart = char:FindFirstChild("LowerTorso") or char:FindFirstChild("HumanoidRootPart")
	table.sort(ObjectList, function(a, b)
		return (RootPart.Position - a.Position).Magnitude < (RootPart.Position - b.Position).Magnitude
	end)
end

local function getChestsSorted()
	if FirstRun then
		FirstRun = false
		for _, obj in pairs(game:GetDescendants()) do
			if obj:IsA("Part") and obj.Name:find("Chest") then
				table.insert(UncheckedChests, obj)
			end
		end
	end

	local Chests = {}
	for _, chest in pairs(UncheckedChests) do
		if chest and chest.Parent and chest:FindFirstChild("TouchInterest") then
			table.insert(Chests, chest)
		end
	end

	DistanceFromPlrSort(Chests)
	return Chests
end

local function toggleNoclip(state)
	local char = getCharacter()
	for _, v in pairs(char:GetChildren()) do
		if v:IsA("BasePart") then
			v.CanCollide = not state
		end
	end
end

local function Teleport(cf)
	local RootPart = getCharacter().HumanoidRootPart
	toggleNoclip(true)
	RootPart.CFrame = cf + Vector3.new(0, 3, 0)
	toggleNoclip(false)
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ChestFarmGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local Background = Instance.new("Frame")
Background.Size = UDim2.new(0, 360, 0, 170)
Background.Position = UDim2.new(0, 18, 0, 140)
Background.BackgroundColor3 = Color3.fromRGB(12, 12, 12)
Background.BorderSizePixel = 0
Background.Parent = ScreenGui

local UICornerBG = Instance.new("UICorner")
UICornerBG.CornerRadius = UDim.new(0, 18)
UICornerBG.Parent = Background

local UIStrokeBG = Instance.new("UIStroke")
UIStrokeBG.Thickness = 1
UIStrokeBG.Color = Color3.fromRGB(50, 50, 50)
UIStrokeBG.Transparency = 0.2
UIStrokeBG.Parent = Background

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, -20, 0, 32)
Title.Position = UDim2.new(0, 10, 0, 10)
Title.BackgroundTransparency = 1
Title.Text = "Chest Farm"
Title.TextColor3 = Color3.fromRGB(235, 235, 235)
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.Parent = Background

local Status = Instance.new("TextLabel")
Status.Size = UDim2.new(1, -20, 0, 24)
Status.Position = UDim2.new(0, 10, 0, 52)
Status.BackgroundTransparency = 1
Status.Text = "Status: Starting..."
Status.TextColor3 = Color3.fromRGB(190, 190, 190)
Status.Font = Enum.Font.Gotham
Status.TextSize = 14
Status.TextXAlignment = Enum.TextXAlignment.Left
Status.Parent = Background

local ChestCountLabel = Instance.new("TextLabel")
ChestCountLabel.Size = UDim2.new(1, -20, 0, 24)
ChestCountLabel.Position = UDim2.new(0, 10, 0, 78)
ChestCountLabel.BackgroundTransparency = 1
ChestCountLabel.Text = "Chests: ..."
ChestCountLabel.TextColor3 = Color3.fromRGB(190, 190, 190)
ChestCountLabel.Font = Enum.Font.Gotham
ChestCountLabel.TextSize = 14
ChestCountLabel.TextXAlignment = Enum.TextXAlignment.Left
ChestCountLabel.Parent = Background

local PlaceLabel = Instance.new("TextLabel")
PlaceLabel.Size = UDim2.new(1, -20, 0, 24)
PlaceLabel.Position = UDim2.new(0, 10, 0, 104)
PlaceLabel.BackgroundTransparency = 1
PlaceLabel.Text = "Next Place: " .. tostring(NEXT_PLACE_ID)
PlaceLabel.TextColor3 = Color3.fromRGB(190, 190, 190)
PlaceLabel.Font = Enum.Font.Gotham
PlaceLabel.TextSize = 14
PlaceLabel.TextXAlignment = Enum.TextXAlignment.Left
PlaceLabel.Parent = Background

local AttemptsLabel = Instance.new("TextLabel")
AttemptsLabel.Size = UDim2.new(1, -20, 0, 24)
AttemptsLabel.Position = UDim2.new(0, 10, 0, 130)
AttemptsLabel.BackgroundTransparency = 1
AttemptsLabel.Text = "Teleport Attempts: 0/" .. tostring(PLACE_MAX_ATTEMPTS)
AttemptsLabel.TextColor3 = Color3.fromRGB(190, 190, 190)
AttemptsLabel.Font = Enum.Font.Gotham
AttemptsLabel.TextSize = 14
AttemptsLabel.TextXAlignment = Enum.TextXAlignment.Left
AttemptsLabel.Parent = Background

task.spawn(function()
	while task.wait(5) do
		pcall(function()
			ReplicatedStorage.Remotes.CommF_:InvokeServer("SetTeam", "Marines")
		end)
	end
end)

local Teleported = false
local TeleportAttempts = 0

local function TeleportToNextPlace()
	if Teleported then return end
	Teleported = true

	Status.Text = "Status: No chests left. Teleporting..."
	task.spawn(function()
		while TeleportAttempts < PLACE_MAX_ATTEMPTS do
			TeleportAttempts += 1
			AttemptsLabel.Text = "Teleport Attempts: " .. tostring(TeleportAttempts) .. "/" .. tostring(PLACE_MAX_ATTEMPTS)

			pcall(function()
				TeleportService:Teleport(NEXT_PLACE_ID, LocalPlayer)
			end)

			task.wait(PLACE_RETRY_DELAY)
		end

		Status.Text = "Status: Teleport failed (max attempts)."
	end)
end

local LastChest = nil
local LastTPTime = 0
local Farming = false

local function startFarm()
	if Farming then return end
	Farming = true

	Status.Text = "Status: Farming..."

	task.spawn(function()
		while task.wait() do
			if Teleported then
				break
			end

			local Chests = getChestsSorted()
			ChestCountLabel.Text = "Chests: " .. tostring(#Chests)

			if #Chests > 0 then
				local chest = Chests[1]

				if chest ~= LastChest or (time() - LastTPTime) > TP_CHEST_COOLDOWN then
					LastChest = chest
					LastTPTime = time()
					Status.Text = "Status: Teleporting to chest..."
					Teleport(chest.CFrame)
				end
			else
				TeleportToNextPlace()
				break
			end
		end

		Farming = false
	end)
end

LocalPlayer.CharacterAdded:Connect(function()
	task.wait(1)
	startFarm()
end)

startFarm()
