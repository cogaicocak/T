
-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")

-- Variables
local LocalPlayer = Players.LocalPlayer

-- Teleport Configuration
local NEXT_PLACE_ID = 100117331123089
local NoChestTime = 0
local NoChestThreshold = 3
local HasTeleported = false
local RetryDelay = 0.5

-- Status tracking
local CurrentStatus = "Initializing..."
local ChestsCollected = 0
local StatusLabel -- Will be set in createGui

local function getCharacter()
	if not LocalPlayer.Character then
		LocalPlayer.CharacterAdded:Wait()
	end
	LocalPlayer.Character:WaitForChild("HumanoidRootPart")
	return LocalPlayer.Character
end

-- Function to update status
local function updateStatus(newStatus)
	CurrentStatus = newStatus
	if StatusLabel then
		StatusLabel.Text = "Status: " .. newStatus
		print("üìä " .. newStatus)
	end
end

-- Create GUI v·ªõi Status Display
local function createGui()
	local oldGui = LocalPlayer.PlayerGui:FindFirstChild("ChestFarmGUI")
	if oldGui then
		oldGui:Destroy()
	end

	local gui = Instance.new("ScreenGui")
	gui.Name = "ChestFarmGUI"
	gui.IgnoreGuiInset = true
	gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	gui.DisplayOrder = 999999
	gui.ResetOnSpawn = false
	gui.Parent = LocalPlayer.PlayerGui

	local background = Instance.new("Frame")
	background.Name = "Background"
	background.Parent = gui
	background.BackgroundColor3 = Color3.fromRGB(8, 8, 8)
	background.BackgroundTransparency = 1
	background.Size = UDim2.new(1, 0, 1, 0)
	background.Position = UDim2.new(0, 0, 0, 0)
	background.BorderSizePixel = 0

	local container = Instance.new("Frame")
	container.Name = "Container"
	container.Parent = background
	container.Size = UDim2.new(0, 550, 0, 260) -- TƒÉng chi·ªÅu cao ƒë·ªÉ ch·ª©a status
	container.Position = UDim2.new(0.5, 0, 0.5, 0)
	container.AnchorPoint = Vector2.new(0.5, 0.5)
	container.BackgroundTransparency = 1

	local glowFrame = Instance.new("Frame")
	glowFrame.Name = "GlowFrame"
	glowFrame.Parent = container
	glowFrame.Size = UDim2.new(1, 40, 1, 40)
	glowFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
	glowFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	glowFrame.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
	glowFrame.BackgroundTransparency = 1
	glowFrame.ZIndex = 0

	local glowCorner = Instance.new("UICorner")
	glowCorner.CornerRadius = UDim.new(0, 20)
	glowCorner.Parent = glowFrame

	local contentFrame = Instance.new("Frame")
	contentFrame.Name = "ContentFrame"
	contentFrame.Parent = container
	contentFrame.Size = UDim2.new(1, 0, 1, 0)
	contentFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
	contentFrame.AnchorPoint = Vector2.new(0.5, 0.5)
	contentFrame.BackgroundColor3 = Color3.fromRGB(18, 18, 18)
	contentFrame.BackgroundTransparency = 1
	contentFrame.ZIndex = 1

	local contentCorner = Instance.new("UICorner")
	contentCorner.CornerRadius = UDim.new(0, 15)
	contentCorner.Parent = contentFrame

	local borderStroke = Instance.new("UIStroke")
	borderStroke.Color = Color3.fromRGB(70, 70, 70)
	borderStroke.Thickness = 1
	borderStroke.Transparency = 1
	borderStroke.Parent = contentFrame

	local topLine = Instance.new("Frame")
	topLine.Name = "TopLine"
	topLine.Parent = contentFrame
	topLine.Size = UDim2.new(0, 0, 0, 2)
	topLine.Position = UDim2.new(0.5, 0, 0.12, 0)
	topLine.AnchorPoint = Vector2.new(0.5, 0.5)
	topLine.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
	topLine.BorderSizePixel = 0
	topLine.ZIndex = 3

	local topGradient = Instance.new("UIGradient")
	topGradient.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0, Color3.fromRGB(50, 50, 50)),
		ColorSequenceKeypoint.new(0.5, Color3.fromRGB(180, 180, 180)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(50, 50, 50))
	})
	topGradient.Parent = topLine

	-- Main text
	local mainText = Instance.new("TextLabel")
	mainText.Name = "MainText"
	mainText.Parent = contentFrame
	mainText.Size = UDim2.new(0.9, 0, 0.25, 0)
	mainText.Position = UDim2.new(0.5, 0, 0.28, 0)
	mainText.AnchorPoint = Vector2.new(0.5, 0.5)
	mainText.BackgroundTransparency = 1
	mainText.Text = "Auto Farm Chest"
	mainText.TextColor3 = Color3.fromRGB(240, 240, 240)
	mainText.TextSize = 42
	mainText.Font = Enum.Font.GothamBold
	mainText.TextTransparency = 1
	mainText.TextXAlignment = Enum.TextXAlignment.Center
	mainText.TextYAlignment = Enum.TextYAlignment.Center
	mainText.ZIndex = 3

	-- Shadow text
	local shadowText = Instance.new("TextLabel")
	shadowText.Name = "ShadowText"
	shadowText.Parent = contentFrame
	shadowText.Size = mainText.Size
	shadowText.Position = UDim2.new(0.5, 2, 0.28, 2)
	shadowText.AnchorPoint = Vector2.new(0.5, 0.5)
	shadowText.BackgroundTransparency = 1
	shadowText.Text = mainText.Text
	shadowText.TextColor3 = Color3.fromRGB(0, 0, 0)
	shadowText.TextSize = mainText.TextSize
	shadowText.Font = mainText.Font
	shadowText.TextTransparency = 1
	shadowText.TextXAlignment = Enum.TextXAlignment.Center
	shadowText.TextYAlignment = Enum.TextYAlignment.Center
	shadowText.ZIndex = 2

	-- üÜï STATUS LABEL
	local statusLabel = Instance.new("TextLabel")
	statusLabel.Name = "StatusLabel"
	statusLabel.Parent = contentFrame
	statusLabel.Size = UDim2.new(0.9, 0, 0.15, 0)
	statusLabel.Position = UDim2.new(0.5, 0, 0.52, 0)
	statusLabel.AnchorPoint = Vector2.new(0.5, 0.5)
	statusLabel.BackgroundTransparency = 1
	statusLabel.Text = "Status: " .. CurrentStatus
	statusLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
	statusLabel.TextSize = 18
	statusLabel.Font = Enum.Font.GothamMedium
	statusLabel.TextTransparency = 1
	statusLabel.TextXAlignment = Enum.TextXAlignment.Center
	statusLabel.TextYAlignment = Enum.TextYAlignment.Center
	statusLabel.ZIndex = 3
	StatusLabel = statusLabel -- Set global reference

	-- üÜï CHESTS COLLECTED COUNTER
	local chestCounter = Instance.new("TextLabel")
	chestCounter.Name = "ChestCounter"
	chestCounter.Parent = contentFrame
	chestCounter.Size = UDim2.new(0.9, 0, 0.12, 0)
	chestCounter.Position = UDim2.new(0.5, 0, 0.68, 0)
	chestCounter.AnchorPoint = Vector2.new(0.5, 0.5)
	chestCounter.BackgroundTransparency = 1
	chestCounter.Text = "Chests: 0"
	chestCounter.TextColor3 = Color3.fromRGB(160, 160, 160)
	chestCounter.TextSize = 16
	chestCounter.Font = Enum.Font.Gotham
	chestCounter.TextTransparency = 1
	chestCounter.TextXAlignment = Enum.TextXAlignment.Center
	chestCounter.TextYAlignment = Enum.TextYAlignment.Center
	chestCounter.ZIndex = 3

	-- Update chest counter continuously
	task.spawn(function()
		while chestCounter and chestCounter.Parent do
			chestCounter.Text = "Chests Collected: " .. ChestsCollected
			task.wait(0.5)
		end
	end)

	-- Credit text
	local creditText = Instance.new("TextLabel")
	creditText.Name = "CreditText"
	creditText.Parent = contentFrame
	creditText.Size = UDim2.new(0.9, 0, 0.12, 0)
	creditText.Position = UDim2.new(0.5, 0, 0.83, 0)
	creditText.AnchorPoint = Vector2.new(0.5, 0.5)
	creditText.BackgroundTransparency = 1
	creditText.Text = "made by VuongDacThong"
	creditText.TextColor3 = Color3.fromRGB(150, 150, 150)
	creditText.TextSize = 18
	creditText.Font = Enum.Font.Gotham
	creditText.TextTransparency = 1
	creditText.TextXAlignment = Enum.TextXAlignment.Center
	creditText.TextYAlignment = Enum.TextYAlignment.Center
	creditText.ZIndex = 3

	-- Decorative dots
	local dotsContainer = Instance.new("Frame")
	dotsContainer.Name = "DotsContainer"
	dotsContainer.Parent = contentFrame
	dotsContainer.Size = UDim2.new(0.2, 0, 0.04, 0)
	dotsContainer.Position = UDim2.new(0.5, 0, 0.94, 0)
	dotsContainer.AnchorPoint = Vector2.new(0.5, 0.5)
	dotsContainer.BackgroundTransparency = 1
	dotsContainer.ZIndex = 3

	for i = 1, 3 do
		local dot = Instance.new("Frame")
		dot.Name = "Dot" .. i
		dot.Parent = dotsContainer
		dot.Size = UDim2.new(0, 6, 0, 6)
		dot.Position = UDim2.new((i - 1) * 0.4 + 0.1, 0, 0.5, 0)
		dot.AnchorPoint = Vector2.new(0.5, 0.5)
		dot.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
		dot.BorderSizePixel = 0
		dot.BackgroundTransparency = 1

		local dotCorner = Instance.new("UICorner")
		dotCorner.CornerRadius = UDim.new(1, 0)
		dotCorner.Parent = dot
	end

	-- ===== ANIMATIONS =====

	-- Fade In
	task.spawn(function()
		local fadeInfo = TweenInfo.new(1.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
		TweenService:Create(background, fadeInfo, { BackgroundTransparency = 0.4 }):Play()
		TweenService:Create(contentFrame, fadeInfo, { BackgroundTransparency = 0.05 }):Play()
		TweenService:Create(borderStroke, fadeInfo, { Transparency = 0.6 }):Play()
		task.wait(0.3)
		TweenService:Create(mainText, fadeInfo, { TextTransparency = 0 }):Play()
		TweenService:Create(shadowText, fadeInfo, { TextTransparency = 0.8 }):Play()
		task.wait(0.2)
		TweenService:Create(statusLabel, fadeInfo, { TextTransparency = 0.3 }):Play()
		TweenService:Create(chestCounter, fadeInfo, { TextTransparency = 0.4 }):Play()
		TweenService:Create(creditText, fadeInfo, { TextTransparency = 0.4 }):Play()
	end)

	-- Glow Pulse
	task.spawn(function()
		task.wait(1)
		while glowFrame and glowFrame.Parent do
			TweenService:Create(glowFrame, TweenInfo.new(3, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { BackgroundTransparency = 0.9 }):Play()
			task.wait(3)
			TweenService:Create(glowFrame, TweenInfo.new(3, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { BackgroundTransparency = 1 }):Play()
			task.wait(3)
		end
	end)

	-- Top Line Expand
	task.spawn(function()
		task.wait(0.8)
		TweenService:Create(topLine, TweenInfo.new(1.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), { Size = UDim2.new(0.6, 0, 0, 2) }):Play()
		task.wait(1.5)
		while topGradient and topGradient.Parent do
			local flow = TweenService:Create(topGradient, TweenInfo.new(3, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut), { Offset = Vector2.new(1, 0) })
			flow:Play()
			flow.Completed:Wait()
			topGradient.Offset = Vector2.new(-1, 0)
		end
	end)

	-- Text Breathing
	task.spawn(function()
		task.wait(2)
		while mainText and mainText.Parent do
			TweenService:Create(mainText, TweenInfo.new(4, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { TextColor3 = Color3.fromRGB(200, 200, 200) }):Play()
			task.wait(4)
			TweenService:Create(mainText, TweenInfo.new(4, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { TextColor3 = Color3.fromRGB(240, 240, 240) }):Play()
			task.wait(4)
		end
	end)

	-- Dots Animation
	task.spawn(function()
		task.wait(1.5)
		local dots = dotsContainer:GetChildren()
		while dotsContainer and dotsContainer.Parent do
			for _, dot in ipairs(dots) do
				if dot:IsA("Frame") then
					TweenService:Create(dot, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut), { BackgroundTransparency = 0.3 }):Play()
					task.wait(0.15)
				end
			end
			task.wait(0.3)
			for _, dot in ipairs(dots) do
				if dot:IsA("Frame") then
					TweenService:Create(dot, TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.InOut), { BackgroundTransparency = 1 }):Play()
				end
			end
			task.wait(1)
		end
	end)

	-- Border Glow
	task.spawn(function()
		task.wait(2.5)
		while borderStroke and borderStroke.Parent do
			TweenService:Create(borderStroke, TweenInfo.new(5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { Color = Color3.fromRGB(100, 100, 100), Transparency = 0.4 }):Play()
			task.wait(5)
			TweenService:Create(borderStroke, TweenInfo.new(5, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { Color = Color3.fromRGB(70, 70, 70), Transparency = 0.6 }):Play()
			task.wait(5)
		end
	end)

	-- Credit Fade
	task.spawn(function()
		task.wait(3)
		while creditText and creditText.Parent do
			TweenService:Create(creditText, TweenInfo.new(6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { TextTransparency = 0.7 }):Play()
			task.wait(6)
			TweenService:Create(creditText, TweenInfo.new(6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut), { TextTransparency = 0.4 }):Play()
			task.wait(6)
		end
	end)

	print("‚úÖ GUI with Status Display Loaded!")
	return gui, mainText
end

-- Chest detection
local UncheckedChests, FirstRun = {}, true
local function getChestsSorted()
	if FirstRun then
		FirstRun = false
		updateStatus("Scanning for chests...")
		for _, Object in pairs(game:GetDescendants()) do
			if Object.Name:find("Chest") and Object.ClassName == "Part" then
				table.insert(UncheckedChests, Object)
			end
		end
		updateStatus("Found " .. #UncheckedChests .. " total chests")
	end

	local Chests = {}
	for _, Chest in pairs(UncheckedChests) do
		if Chest:FindFirstChild("TouchInterest") then
			table.insert(Chests, Chest)
		end
	end

	pcall(function()
		local RootPart = getCharacter().HumanoidRootPart
		table.sort(Chests, function(ChestA, ChestB)
			local RootPos = RootPart.Position
			local DistanceA = (RootPos - ChestA.Position).Magnitude
			local DistanceB = (RootPos - ChestB.Position).Magnitude
			return DistanceA < DistanceB
		end)
	end)

	return Chests
end

-- Noclip toggle
local function toggleNoclip(Toggle)
	pcall(function()
		for _, v in pairs(getCharacter():GetChildren()) do
			if v:IsA("BasePart") then
				v.CanCollide = not Toggle
			end
		end
	end)
end

-- Teleport
local function Teleport(Goal)
	pcall(function()
		local RootPart = getCharacter().HumanoidRootPart
		toggleNoclip(true)
		RootPart.CFrame = Goal + Vector3.new(0, 3, 0)
		toggleNoclip(false)
		ChestsCollected = ChestsCollected + 1
	end)
end

-- Auto Retry Teleport
local function TeleportToNextPlace()
	if HasTeleported then return end
	HasTeleported = true
	
	updateStatus("Teleporting to next place...")
	
	task.spawn(function()
		local attemptCount = 0
		while true do
			attemptCount = attemptCount + 1
			updateStatus("Teleport attempt #" .. attemptCount)
			
			local success, errorMsg = pcall(function()
				TeleportService:Teleport(NEXT_PLACE_ID, LocalPlayer)
			end)
			
			if not success then
				updateStatus("Failed! Retrying... (" .. attemptCount .. ")")
			end
			
			task.wait(RetryDelay)
		end
	end)
end

-- Auto Reconnect
local function setupAutoReconnect()
	game:GetService("CoreGui").RobloxPromptGui.promptOverlay.ChildAdded:Connect(function(prompt)
		if prompt.Name == "ErrorPrompt" or prompt.Name == "ConnectionErrorPrompt" then
			updateStatus("Kicked! Reconnecting...")
			task.wait(RetryDelay)
			
			task.spawn(function()
				local reconnectCount = 0
				while true do
					reconnectCount = reconnectCount + 1
					updateStatus("Reconnect attempt #" .. reconnectCount)
					pcall(function()
						TeleportService:Teleport(game.PlaceId, LocalPlayer)
					end)
					task.wait(RetryDelay)
				end
			end)
		end
	end)
	
	TeleportService.TeleportInitFailed:Connect(function(player, result, errorMessage)
		updateStatus("Teleport failed: " .. tostring(result))
	end)
end

-- Main farm loop
local function startFarm()
	task.spawn(function()
		while task.wait() do
			pcall(function()
				local Chests = getChestsSorted()

				if #Chests > 0 then
					NoChestTime = 0
					updateStatus("Farming chest (" .. #Chests .. " remaining)")
					Teleport(Chests[1].CFrame)
				else
					NoChestTime = NoChestTime + 0.03
					updateStatus("No chests found... (" .. math.floor(NoChestTime) .. "s)")
					if NoChestTime >= NoChestThreshold then
						TeleportToNextPlace()
					end
				end
			end)
		end
	end)
end

-- Auto Marines
task.spawn(function()
	local rs = ReplicatedStorage
	while task.wait(5) do
		pcall(function()
			rs.Remotes.CommF_:InvokeServer("SetTeam", "Marines")
		end)
	end
end)

-- Character respawn
LocalPlayer.CharacterAdded:Connect(function()
	task.wait(1)
	NoChestTime = 0
	HasTeleported = false
	updateStatus("Character respawned")
	pcall(startFarm)
end)

-- Initialize
print("üöÄ Starting Auto Chest Farm with Status Display...")
updateStatus("Initializing...")
pcall(function()
	createGui()
	setupAutoReconnect()
	task.wait(1)
	updateStatus("Starting farm...")
	startFarm()
end)
